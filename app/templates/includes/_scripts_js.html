<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    .upload-zone { border: 2px dashed #dee2e6; border-radius: 12px; padding: 20px; text-align: center; background: #f8f9fa; cursor: pointer; transition: 0.3s; }
    .upload-zone:hover { border-color: #0d6efd; background: #f0f7ff; }
    .preview-item { width: 95px; position: relative; display: inline-block; margin: 5px; vertical-align: top; }
    .preview-item img, .preview-item .icon-box { height: 80px; width: 95px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; background: white; }
    .btn-remove { position: absolute; top: -10px; right: -10px; width: 24px; height: 24px; border-radius: 50%; font-size: 14px; padding: 0; line-height: 1; }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // --- 1. MAPA ---
        const initialLat = {{ p.latitud if (p and p.latitud) else -31.4167 }};
        const initialLng = {{ p.longitud if (p and p.longitud) else -64.1833 }};
        const map = L.map('map-editor').setView([initialLat, initialLng], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let marker = L.marker([initialLat, initialLng], {draggable: true}).addTo(map);

        marker.on('dragend', function() {
            const pos = marker.getLatLng();
            document.getElementById('res-lat').value = pos.lat;
            document.getElementById('res-lng').value = pos.lng;
        });

        document.getElementById('btn-search-map').onclick = () => {
            const q = document.getElementById('address-search').value;
            // Nominatim API: Buscamos la dirección
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&addressdetails=1&limit=1`)
                .then(r => r.json()).then(data => {
                    if(data.length > 0) {
                        const item = data[0];
                        map.setView([item.lat, item.lon], 16);
                        marker.setLatLng([item.lat, item.lon]);
                        document.getElementById('res-lat').value = item.lat;
                        document.getElementById('res-lng').value = item.lon;
                        
                        const a = item.address;
                        
                        // Rellenamos los campos detectados
                        document.getElementById('res-calle').value = a.road || '';
                        document.getElementById('res-altura').value = a.house_number || '';
                        document.getElementById('res-localidad').value = a.city || a.town || a.village || 'Córdoba';
                        document.getElementById('res-barrio').value = a.suburb || a.neighbourhood || '';
                        
                        // --- ESTO ES LO NUEVO: CÓDIGO POSTAL ---
                        const cpField = document.getElementById('res-cp');
                        if (cpField) {
                            cpField.value = a.postcode || '';
                        }
                    } else {
                        alert("No se encontró la dirección exacta. Intentá agregando la ciudad.");
                    }
                });
        };

        // --- 2. EDITOR QUILL ---
        var quill = new Quill("#editor-container", { theme: "snow", modules: { toolbar: [['bold', 'italic'], [{list:'ordered'}, {list:'bullet'}]] } });
        document.getElementById("propiedadForm").onsubmit = () => { document.getElementById("descripcion_input").value = quill.root.innerHTML; };
    });

    // --- 3. MULTIMEDIA ---
    const fileStores = { foto: new DataTransfer(), video: new DataTransfer(), doc: new DataTransfer() };
    function handleFileSelect(input, containerId, type) {
        for (let file of input.files) { fileStores[type].items.add(file); }
        input.files = fileStores[type].files;
        renderPreviews(containerId, type, input.id);
    }
    function renderPreviews(containerId, type, inputId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        Array.from(fileStores[type].files).forEach((file, index) => {
            const div = document.createElement("div"); div.className = "preview-item";
            let content = type === 'foto' ? `<img src="${URL.createObjectURL(file)}">` : `<div class="icon-box d-flex align-items-center justify-content-center"><i class="bi bi-file-earmark-play fs-2"></i></div>`;
            div.innerHTML = `${content}<button type="button" onclick="removeFile('${type}', ${index}, '${containerId}', '${inputId}')" class="btn btn-danger btn-remove">×</button>`;
            container.appendChild(div);
        });
    }
    function removeFile(type, index, containerId, inputId) {
        const newStore = new DataTransfer();
        Array.from(fileStores[type].files).forEach((f, i) => { if (i !== index) newStore.items.add(f); });
        fileStores[type] = newStore;
        document.getElementById(inputId).files = newStore.files;
        renderPreviews(containerId, type, inputId);
    }

    // --- 4. PROPIETARIOS ---
    function agregarPropietario() {
        const div = document.createElement("div"); div.className = "row mb-3 border-bottom pb-3 mt-2";
        div.innerHTML = `
            <div class="col-md-3"><label class="small fw-bold">Nombre</label><input type="text" name="propietario_nombre[]" class="form-control form-control-sm" required></div>
            <div class="col-md-3"><label class="small fw-bold">Teléfono</label><input type="text" name="propietario_tel[]" class="form-control form-control-sm"></div>
            <div class="col-md-3"><label class="small fw-bold">Email</label><input type="email" name="propietario_email[]" class="form-control form-control-sm"></div>
            <div class="col-md-2"><label class="small fw-bold">Notas</label><input type="text" name="notas_legajo[]" class="form-control form-control-sm"></div>
            <div class="col-md-1 d-flex align-items-end"><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.row').remove()">×</button></div>`;
        document.getElementById("contenedor-propietarios").appendChild(div);
    }
</script>