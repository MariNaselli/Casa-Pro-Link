{% extends "base.html" %} {% block content %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<div class="container mt-4 mb-5 pb-5">
  <div class="d-flex align-items-center mb-3">
    <i class="bi bi-arrow-left fs-4 me-3" style="cursor: pointer" onclick="window.history.back()"></i>
    <h2 class="mb-0">Editar Propiedad: {{ p.titulo }}</h2>
  </div>

  <form id="propiedadForm" method="POST" enctype="multipart/form-data" class="card p-4 shadow-sm border-0">
    
    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label fw-medium small">Título</label>
        <input type="text" name="titulo" class="form-control" value="{{ p.titulo }}" required />
      </div>
      <div class="col-md-3 mb-3">
        <label class="form-label fw-medium small">Operación</label>
        <select name="operacion" class="form-select">
          <option value="Venta" {% if p.operacion == "Venta" %}selected{% endif %}>Venta</option>
          <option value="Alquiler" {% if p.operacion == "Alquiler" %}selected{% endif %}>Alquiler</option>
        </select>
      </div>
      <div class="col-md-3 mb-3">
        <label class="form-label fw-medium small">Precio</label>
        <div class="input-group">
          <select name="moneda" class="form-select" style="max-width: 90px">
            <option value="ARS" {% if p.moneda == "ARS" %}selected{% endif %}>ARS</option>
            <option value="USD" {% if p.moneda == "USD" %}selected{% endif %}>USD</option>
          </select>
          <input type="number" name="precio" class="form-control" value="{{ p.precio }}" required />
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-3 mb-3"><label class="small">Calle</label><input type="text" name="calle" class="form-control" value="{{ p.calle }}" /></div>
      <div class="col-md-1 mb-3"><label class="small">Altura</label><input type="text" name="altura" class="form-control" value="{{ p.altura }}" /></div>
      <div class="col-md-2 mb-3"><label class="small">Barrio</label><input type="text" name="barrio" class="form-control" value="{{ p.barrio }}" /></div>
      <div class="col-md-3 mb-3"><label class="small text-primary fw-bold">M2 Totales</label><input type="number" name="m2_totales" class="form-control" value="{{ p.m2_totales }}" /></div>
      <div class="col-md-3 mb-3"><label class="small text-primary fw-bold">M2 Cubiertos</label><input type="number" name="m2_cubiertos" class="form-control" value="{{ p.m2_cubiertos }}" /></div>
    </div>

    <div class="mb-4">
      <label class="form-label fw-bold text-secondary small">Comodidades</label>
      <div class="d-flex flex-wrap gap-3 p-3 border rounded bg-light">
        {% set items = [('cochera','car-front'), ('pileta','water'), ('quincho','fire'), ('patio','tree')] %}
        {% for id, icono in items %}
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="{{ id }}" id="{{ id }}" {% if p[id] %}checked{% endif %}>
          <label class="form-check-label" for="{{ id }}"><i class="bi bi-{{ icono }}"></i> {{ id|capitalize }}</label>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="mb-4">
      <label class="form-label fw-bold text-primary small">Descripción</label>
      <div id="editor-container" style="height: 200px; background: white; border: 1px solid #ced4da;">{{ p.descripcion|safe }}</div>
      <input type="hidden" name="descripcion" id="descripcion_input" />
    </div>

    <hr>

    <div class="row">
        <div class="col-md-6 mb-4 border-end">
            <label class="form-label fw-bold text-success">Fotos Públicas</label>
            <div class="d-flex flex-wrap gap-2 mb-3 p-2 border rounded bg-light">
                {% for archivo in p.archivos if archivo.tipo == 'imagen' %}
                <div class="position-relative">
                    <img src="{{ url_for('static', filename='uploads/' + archivo.archivo_nombre) }}" class="rounded border shadow-sm" style="width: 70px; height: 70px; object-fit: cover">
                    <button type="button" onclick="borrarArchivoAjax(this, '{{ archivo.id }}')" class="btn btn-danger btn-sm position-absolute top-0 end-0 p-0" style="width:20px; height:20px;">×</button>
                </div>
                {% endfor %}
            </div>
            <div class="upload-zone py-2 mb-2" onclick="document.getElementById('imagenesInput').click()"><i class="bi bi-plus-circle"></i> Agregar Fotos</div>
            <input type="file" name="imagenes" id="imagenesInput" class="d-none" accept="image/*" multiple onchange="handleFileSelect(this, 'lista-imagenes', 'foto')">
            <div id="lista-imagenes" class="d-flex flex-wrap gap-2"></div>
        </div>

        <div class="col-md-6 mb-4">
            <label class="form-label fw-bold text-success">Videos Públicos</label>
            <div class="d-flex flex-wrap gap-2 mb-3 p-2 border rounded bg-light">
                {% for archivo in p.archivos if archivo.tipo == 'video' %}
                <div class="position-relative">
                    <div class="bg-dark rounded d-flex align-items-center justify-content-center" style="width: 70px; height: 70px;"><i class="bi bi-play-fill text-white"></i></div>
                    <button type="button" onclick="borrarArchivoAjax(this, '{{ archivo.id }}')" class="btn btn-danger btn-sm position-absolute top-0 end-0 p-0" style="width:20px; height:20px;">×</button>
                </div>
                {% endfor %}
            </div>
            <div class="upload-zone py-2 mb-2" onclick="document.getElementById('videosInput').click()"><i class="bi bi-plus-circle"></i> Agregar Videos</div>
            <input type="file" name="videos" id="videosInput" class="d-none" accept="video/*" multiple onchange="handleFileSelect(this, 'lista-videos', 'video')">
            <div id="lista-videos" class="d-flex flex-wrap gap-2"></div>
        </div>
    </div>

    <div class="card border-dark mb-4 shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-bold"><i class="bi bi-shield-lock"></i> Legajo Administrativo</h6>
            <button type="button" class="btn btn-sm btn-outline-light" onclick="agregarPropietario()">+ Nuevo Propietario</button>
        </div>
        <div class="card-body bg-light" id="contenedor-propietarios">
            {% for prop in p.propietarios %}
            <div class="row mb-3 propietario-fila border-bottom pb-3 mt-2">
                <div class="col-md-4 mb-2"><label class="small fw-bold">Nombre y Apellido</label><input type="text" name="propietario_nombre[]" class="form-control form-control-sm" value="{{ prop.nombre }}"></div>
                <div class="col-md-4 mb-2"><label class="small fw-bold">Teléfono</label><input type="text" name="propietario_tel[]" class="form-control form-control-sm" value="{{ prop.telefono }}"></div>
                <div class="col-md-4 mb-2"><label class="small fw-bold">DNI</label><input type="text" name="propietario_dni[]" class="form-control form-control-sm" value="{{ prop.dni }}"></div>
                <div class="col-md-11 mb-2"><label class="small fw-bold text-danger">Notas Administrativas</label><textarea name="notas_legajo[]" class="form-control form-control-sm" rows="2">{{ prop.notas_legajo }}</textarea></div>
                <div class="col-md-1 d-flex align-items-center"><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.propietario-fila').remove()">×</button></div>
            </div>
            {% endfor %}
        </div>
        <div class="card-footer bg-white border-top">
            <label class="form-label fw-bold text-danger small">Documentos Actuales</label>
            <div class="d-flex flex-wrap gap-2 mb-3">
                {% for archivo in p.archivos if archivo.tipo == 'documento' %}
                <div class="position-relative p-2 border rounded bg-light d-flex align-items-center" style="min-width: 150px;">
                    <i class="bi bi-file-earmark-lock me-2"></i>
                    <span class="small text-truncate" style="max-width: 100px;">{{ archivo.archivo_nombre.split('_')[-1] }}</span>
                    <button type="button" onclick="borrarArchivoAjax(this, '{{ archivo.id }}')" class="btn btn-danger btn-sm position-absolute top-0 end-0 p-0" style="width:20px; height:20px;">×</button>
                </div>
                {% endfor %}
            </div>
            <div class="upload-zone py-2 mb-2" onclick="document.getElementById('docsInput').click()"><i class="bi bi-file-earmark-arrow-up"></i> Agregar Planos/Escrituras</div>
            <input type="file" name="documentos" id="docsInput" class="d-none" accept=".pdf,image/*" multiple onchange="handleFileSelect(this, 'lista-docs', 'doc')">
            <div id="lista-docs" class="mt-2 d-flex flex-wrap gap-2"></div>
        </div>
    </div>

    <div class="d-flex justify-content-between mt-4">
      <a href="{{ url_for('home') }}" class="btn btn-secondary px-4">Cancelar</a>
      <button type="submit" class="btn btn-primary px-5 fw-bold">Guardar Todos los Cambios</button>
    </div>
  </form>
</div>

<style>
  .upload-zone { border: 2px dashed #dee2e6; border-radius: 8px; text-align: center; background: #f8f9fa; cursor: pointer; transition: 0.3s; }
  .upload-zone:hover { border-color: #0d6efd; background: #e9ecef; }
  .preview-item { width: 85px; position: relative; }
  .preview-item img, .preview-item .icon-box { height: 80px; width: 85px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd; }
  .preview-item .icon-box { display: flex; align-items: center; justify-content: center; background: #343a40; color: white; }
</style>

<script>
    // 1. AJAX PARA BORRAR ARCHIVOS EXISTENTES
    function borrarArchivoAjax(boton, archivoId) {
        if(!confirm("¿Borrar este archivo permanentemente?")) return;
        fetch(`/borrar_archivo/${archivoId}`, { method: "POST" }).then(res => {
            if (res.ok) {
                const div = boton.closest(".position-relative");
                div.style.opacity = "0";
                setTimeout(() => div.remove(), 300);
            }
        });
    }

    // 2. MANAGER DE NUEVOS ARCHIVOS (DataTransfer)
    const fileStores = { foto: new DataTransfer(), video: new DataTransfer(), doc: new DataTransfer() };

    function handleFileSelect(input, containerId, type) {
        const store = fileStores[type];
        for (let file of input.files) { store.items.add(file); }
        input.files = store.files;
        renderPreviews(containerId, type, input.id);
    }

    function renderPreviews(containerId, type, inputId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        const store = fileStores[type];
        Array.from(store.files).forEach((file, index) => {
            const div = document.createElement("div");
            div.className = "preview-item";
            let content = (type === 'foto' || (type === 'doc' && file.type.startsWith('image/'))) ? 
                          `<img src="${URL.createObjectURL(file)}">` : 
                          `<div class="icon-box bg-dark"><i class="bi ${type === 'video' ? 'bi-play-circle' : 'bi-file-earmark-pdf'} fs-3"></i></div>`;
            div.innerHTML = `${content}
                <button type="button" onclick="removeFile('${type}', ${index}, '${containerId}', '${inputId}')" class="btn btn-danger btn-sm position-absolute top-0 end-0 py-0" style="width:20px; height:20px; border-radius:50%">×</button>
                <div class="small text-truncate text-center" style="font-size: 9px">${file.name}</div>`;
            container.appendChild(div);
        });
    }

    function removeFile(type, index, containerId, inputId) {
        const newStore = new DataTransfer();
        Array.from(fileStores[type].files).forEach((f, i) => { if (i !== index) newStore.items.add(f); });
        fileStores[type] = newStore;
        document.getElementById(inputId).files = newStore.files;
        renderPreviews(containerId, type, inputId);
    }

    // 3. QUILL EDITOR
    var quill = new Quill('#editor-container', { theme: 'snow', modules: { toolbar: [['bold', 'italic'], [{ 'list': 'bullet' }, { 'list': 'ordered' }], ['clean']] } });
    document.getElementById('propiedadForm').onsubmit = () => { document.getElementById('descripcion_input').value = quill.root.innerHTML; };

    // 4. DINÁMICA DE PROPIETARIOS
    function agregarPropietario() {
        const div = document.createElement('div');
        div.className = 'row mb-3 propietario-fila border-bottom pb-3 mt-2';
        div.innerHTML = `
            <div class="col-md-4 mb-2"><label class="small fw-bold">Nombre y Apellido</label><input type="text" name="propietario_nombre[]" class="form-control form-control-sm"></div>
            <div class="col-md-4 mb-2"><label class="small fw-bold">Teléfono</label><input type="text" name="propietario_tel[]" class="form-control form-control-sm"></div>
            <div class="col-md-4 mb-2"><label class="small fw-bold">DNI</label><input type="text" name="propietario_dni[]" class="form-control form-control-sm"></div>
            <div class="col-md-11 mb-2"><label class="small fw-bold text-danger">Notas Administrativas</label><textarea name="notas_legajo[]" class="form-control form-control-sm" rows="2"></textarea></div>
            <div class="col-md-1 d-flex align-items-center"><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.propietario-fila').remove()">×</button></div>`;
        document.getElementById('contenedor-propietarios').appendChild(div);
    }
</script>
{% endblock %}
