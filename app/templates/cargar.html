{% extends "base.html" %} {% block content %}
<div class="container mt-4 mb-5 pb-5">
  <div class="d-flex align-items-center mb-3">
    <i
      class="bi bi-arrow-left fs-4 me-3"
      style="cursor: pointer"
      onclick="window.history.back()"
      title="Volver"
    ></i>
    <h2 class="mb-0">Cargar Nueva Propiedad</h2>
  </div>

  <form
    action="{{ url_for('cargar') }}"
    method="POST"
    enctype="multipart/form-data"
    class="card p-4 shadow-sm"
  >
    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label fw-medium">Título</label>
        <input
          type="text"
          name="titulo"
          class="form-control"
          placeholder="Ej: Casa 3 dorm. con quincho"
          required
        />
      </div>
      <div class="col-md-3 mb-3">
        <label class="form-label fw-medium">Operación</label>
        <select name="operacion" class="form-select">
          <option value="Venta">Venta</option>
          <option value="Alquiler">Alquiler</option>
        </select>
      </div>
      <div class="col-md-3 mb-3">
        <label class="form-label fw-medium">Precio</label>
        <div class="input-group">
          <select name="moneda" class="form-select" style="max-width: 90px">
            <option value="ARS" selected>ARS</option>
            <option value="USD">USD</option>
          </select>
          <input
            type="number"
            name="precio"
            class="form-control"
            placeholder="Monto"
            step="1"
            min="0"
            required
          />
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label fw-medium">Calle</label>
        <input
          type="text"
          name="calle"
          class="form-control"
          placeholder="Ej: Av. Colón"
          value="{{ p.calle if p else '' }}"
        />
      </div>
      <div class="col-md-2 mb-3">
        <label class="form-label fw-medium">Altura</label>
        <input
          type="text"
          name="altura"
          class="form-control"
          placeholder="123"
          value="{{ p.altura if p else '' }}"
        />
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label fw-medium">Barrio</label>
        <input
          type="text"
          name="barrio"
          class="form-control"
          placeholder="Ej: Nueva Córdoba"
          value="{{ p.barrio if p else '' }}"
        />
      </div>
    </div>

    <div class="row">
      <div class="col-md-3 mb-4">
        <label class="form-label fw-medium">Dormitorios</label>
        <input type="number" name="dormitorios" class="form-control" />
      </div>
      <div class="col-md-3 mb-4">
        <label class="form-label fw-medium">Baños</label>
        <input type="number" name="banios" class="form-control" />
      </div>
      <div class="col-md-3 mb-4">
        <label class="form-label fw-medium">M2 Totales</label>
        <input
          type="number"
          name="m2_totales"
          class="form-control"
          value="{{ p.m2_totales if p else '' }}"
        />
      </div>
      <div class="col-md-3 mb-4">
        <label class="form-label fw-medium">M2 Cubiertos</label>
        <input
          type="number"
          name="m2_cubiertos"
          class="form-control"
          value="{{ p.m2_cubiertos if p else '' }}"
        />
      </div>
    </div>
    <div class="mb-3">
      <label class="form-label fw-medium">Descripción de la Propiedad</label>
      <textarea
        name="descripcion"
        class="form-control"
        rows="4"
        placeholder="Describe los detalles destacados de la propiedad..."
      >
{{ p.descripcion if p else '' }}</textarea
      >
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label fw-bold">Imágenes de la Propiedad</label>
        <div
          class="p-3 border rounded bg-light text-center mb-2"
          style="cursor: pointer"
          onclick="document.getElementById('imagenesInput').click()"
        >
          <i class="bi bi-camera fs-2 text-muted"></i>
          <p class="small mb-0 text-muted">Haz clic para seleccionar fotos</p>
        </div>
        <input
          type="file"
          name="imagenes"
          id="imagenesInput"
          class="form-control d-none"
          accept="image/*"
          multiple
          onchange="previewImages(this)"
        />

        <div
          id="lista-imagenes"
          class="mt-2 small text-primary fw-medium"
        ></div>
      </div>

      <div class="col-md-6 mb-3">
        <label class="form-label fw-bold">Videos de la Propiedad</label>
        <div
          class="p-3 border rounded bg-light text-center mb-2"
          style="cursor: pointer"
          onclick="document.getElementById('videosInput').click()"
        >
          <i class="bi bi-play-btn fs-2 text-muted"></i>
          <p class="small mb-0 text-muted">Haz clic para seleccionar videos</p>
        </div>
        <input
          type="file"
          name="videos"
          id="videosInput"
          class="form-control d-none"
          accept="video/*"
          multiple
          onchange="previewVideos(this)"
        />

        <div id="lista-videos" class="mt-2 small text-danger fw-medium"></div>
      </div>
    </div>

    <script>
      // Creamos un "contenedor" virtual para ir guardando todas las fotos que elijas
      let contenedorFotos = new DataTransfer();
      const inputFotos = document.getElementById("imagenesInput");
      const vistaPrevia = document.getElementById("lista-imagenes");

      function previewImages(input) {
        // Agregamos los nuevos archivos seleccionados al contenedor virtual
        for (let file of input.files) {
          contenedorFotos.items.add(file);
        }

        // Sincronizamos el input con nuestro contenedor virtual
        input.files = contenedorFotos.files;

        // Limpiamos la vista previa y la volvemos a armar con TODO lo acumulado
        vistaPrevia.innerHTML = "";

        if (input.files.length > 0) {
          const grid = document.createElement("div");
          grid.className = "d-flex flex-wrap gap-2 mt-2";
          vistaPrevia.appendChild(grid);

          Array.from(input.files).forEach((f, index) => {
            const reader = new FileReader();
            reader.onload = function (e) {
              const div = document.createElement("div");
              div.className = "position-relative";
              div.innerHTML = `
    <div class="d-flex flex-column align-items-center">
        <div class="position-relative">
            <img src="${e.target.result}" class="rounded border shadow-sm" style="width: 80px; height: 80px; object-fit: cover;">
            <button type="button" onclick="quitarFoto(${index})" class="btn btn-danger btn-sm position-absolute top-0 end-0 p-0" style="width:20px; height:20px; font-size:12px;">×</button>
        </div>
        <span class="text-truncate mt-1" style="max-width: 80px; font-size: 10px;" title="${f.name}">${f.name}</span>
    </div>
`;
              grid.appendChild(div);
            };
            reader.readAsDataURL(f);
          });
        }
      }

      function quitarFoto(index) {
        const nuevoContenedor = new DataTransfer();
        const { files } = contenedorFotos;

        for (let i = 0; i < files.length; i++) {
          if (i !== index) nuevoContenedor.items.add(files[i]);
        }

        contenedorFotos = nuevoContenedor;
        inputFotos.files = contenedorFotos.files;
        previewImages(inputFotos); // Refrescar vista
      }

      // --- Lógica para acumular VIDEOS ---
let contenedorVideos = new DataTransfer();
const inputVideos = document.getElementById("videosInput");
const vistaPreviaVideos = document.getElementById("lista-videos");

function previewVideos(input) {
    for (let file of input.files) {
        contenedorVideos.items.add(file);
    }
    input.files = contenedorVideos.files;
    vistaPreviaVideos.innerHTML = "";

    if (input.files.length > 0) {
        const grid = document.createElement("div");
        grid.className = "d-flex flex-wrap gap-2 mt-2";
        vistaPreviaVideos.appendChild(grid);

        Array.from(input.files).forEach((f, index) => {
            const div = document.createElement("div");
            div.className = "position-relative d-flex flex-column align-items-center";
            div.innerHTML = `
                <div class="position-relative">
                    <div class="rounded border bg-dark d-flex align-items-center justify-content-center shadow-sm" style="width: 80px; height: 80px;">
                        <i class="bi bi-play-fill text-white fs-2"></i>
                        <button type="button" onclick="quitarVideo(${index})" class="btn btn-danger btn-sm position-absolute top-0 end-0 p-0" style="width:20px; height:20px; font-size:12px;">×</button>
                    </div>
                </div>
                <span class="text-truncate mt-1" style="max-width: 80px; font-size: 10px;" title="${f.name}">${f.name}</span>
            `;
            grid.appendChild(div);
        });
    }
}

function quitarVideo(index) {
    const nuevoContenedor = new DataTransfer();
    const { files } = contenedorVideos;
    for (let i = 0; i < files.length; i++) {
        if (i !== index) nuevoContenedor.items.add(files[i]);
    }
    contenedorVideos = nuevoContenedor;
    inputVideos.files = contenedorVideos.files;
    previewVideos(inputVideos); 
}
    </script>

    <div class="bg-light p-3 rounded mb-3">
      <h5 class="mb-3">Datos Propietario/a</h5>
      <div class="row">
        <div class="col-md-6">
          <label class="form-label fw-medium">Nombre</label>
          <input type="text" name="propietario_nombre" class="form-control" />
        </div>
        <div class="col-md-6">
          <label class="form-label fw-medium">Teléfono</label>
          <input type="text" name="propietario_tel" class="form-control" />
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between mt-4">
      <a href="{{ url_for('home') }}" class="btn btn-secondary">Cancelar</a>
      <button type="submit" class="btn btn-success px-4">
        Guardar Propiedad
      </button>
    </div>
  </form>
</div>
{% endblock %}
