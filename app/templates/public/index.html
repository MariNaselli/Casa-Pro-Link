{% extends "base.html" %} 
{% block title %}Catálogo de Propiedades{% endblock %} 

{% block content %}

{% if not current_user.is_authenticated %}
    {% include 'includes/_hero.html' %}
{% endif %}

{% if current_user.is_authenticated %}
<div class="bg-light border-bottom py-4 mb-4 shadow-sm">
    <div class="container">
        <div class="row g-3 align-items-center">
            
            <div class="col-12 col-md-4 text-center text-md-start">
                <h4 class="fw-bold mb-0 text-dark">Panel de Gestión</h4>
                <p class="text-muted small mb-0">Administración de catálogo</p>
            </div>

            <div class="col-12 col-md-5">
                <form action="/" method="GET" class="input-group shadow-sm rounded-pill overflow-hidden border bg-white">
                    <input type="text" name="q" class="form-control border-0 ps-4 py-2" 
                           placeholder="Buscar por título, calle o barrio..." 
                           value="{{ busqueda or '' }}" 
                           style="box-shadow: none;"> <button class="btn btn-white bg-white border-0 text-secondary pe-3" type="submit">
                        <i class="bi bi-search"></i>
                    </button>
                    
                    {% if busqueda %}
                    <a href="/" class="btn btn-white bg-white border-0 text-danger pe-3 d-flex align-items-center">
                        <i class="bi bi-x-circle-fill"></i>
                    </a>
                    {% endif %}
                </form>
            </div>

            <div class="col-12 col-md-3 text-center text-md-end">
                <a href="{{ url_for('cargar') }}" class="btn btn-primary rounded-pill px-4 py-2 fw-bold shadow-sm w-100 w-md-auto">
                    <i class="bi bi-plus-lg me-1"></i> Nueva Propiedad
                </a>
            </div>

        </div>
    </div>
</div>
{% endif %}

<div class="container mt-4">
  {% if current_user.is_authenticated %}
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
        <span class="text-muted small fw-bold">
            <i class="bi bi-list-check me-1"></i> {{ propiedades|length }} propiedades activas
        </span>
        </div>
  {% endif %}

  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4 pb-5">
    {% for p in propiedades %}
    <div class="col">
      <div class="card h-100 shadow-sm border-0 rounded-4 overflow-hidden position-relative hover-card">
        
        {% set img = p.archivos | selectattr('tipo', 'equalto', 'imagen') | first %}
        <div class="position-relative">
            <img src="{{ url_for('static', filename='uploads/' + img.archivo_nombre) if img else url_for('static', filename='img/no-photo.jpg') }}" 
                 class="card-img-top" style="height: 200px; object-fit: cover">
            
            <span class="badge position-absolute top-0 end-0 m-3 {{ 'bg-success' if p.operacion_rel.nombre == 'Venta' else 'bg-warning text-dark' }} rounded-pill px-3 shadow-sm">
                {{ p.operacion_rel.nombre }}
            </span>

            <span class="badge position-absolute bottom-0 start-0 m-3 bg-dark bg-opacity-75 rounded-pill px-2 small">
                {{ p.tipo.nombre }}
            </span>
        </div>

        <div class="card-body p-3 d-flex flex-column">
          <div class="mb-auto">
              <h6 class="fw-bold mb-1 text-truncate" title="{{ p.titulo }}">{{ p.titulo }}</h6>
              <p class="text-muted small mb-2 text-truncate">
                <i class="bi bi-geo-alt-fill text-danger me-1"></i>{{ p.barrio_rel.nombre }}
              </p>
              <h5 class="text-primary fw-bold mb-0">
                {{ p.moneda }} {{ "{:,.0f}".format(p.precio).replace(',', '.') if p.precio else 'Consultar' }}
              </h5>
          </div>
          
          <div class="mt-3 pt-3 border-top w-100">
             {% include 'includes/_acciones.html' %}
          </div>
        </div>

      </div>
    </div>
    {% else %}
    <div class="col-12 text-center py-5">
        <div class="bg-light rounded-circle d-inline-flex p-4 mb-3">
            <i class="bi bi-search fs-1 text-muted opacity-50"></i>
        </div>
        <h5 class="text-muted">No encontramos propiedades</h5>
        <p class="text-muted small">Intenta con otra búsqueda o ubicación.</p>
        <a href="/" class="btn btn-outline-primary rounded-pill px-4">Ver todo el catálogo</a>
    </div>
    {% endfor %}
  </div>
</div>

{% include 'includes/_modal_eliminar.html' %}

<style>
    .hover-card { transition: transform 0.2s ease-in-out; }
    .hover-card:hover { transform: translateY(-5px); }
    /* Ajuste para que el botón 'Nueva Propiedad' no ocupe todo el ancho en PC */
    @media (min-width: 768px) { .w-md-auto { width: auto !important; } }
</style>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/propiedades.js') }}"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const input = document.getElementById('inputUbicacion');
        const menu = document.getElementById('menuSugerencias');
        
        // Si no estamos en la home pública, salimos
        if (!input || !menu) return;

        const todasLasOpciones = {{ sugerencias | default([]) | tojson }};

        input.addEventListener('input', function() {
            const valor = this.value.toLowerCase().trim();
            menu.innerHTML = '';
            
            if (valor.length < 2) {
                menu.classList.add('d-none');
                return;
            }

            const coincidencias = todasLasOpciones.filter(op => op.toLowerCase().includes(valor));

            if (coincidencias.length === 0) {
                menu.classList.add('d-none');
                return;
            }

            coincidencias.forEach(op => {
                const item = document.createElement('button');
                item.className = "list-group-item list-group-item-action text-start border-0 px-3 py-2";
                item.innerHTML = `<i class="bi bi-geo-alt-fill text-danger me-2"></i> ${op}`;
                item.onclick = function(e) {
                    e.preventDefault(); 
                    input.value = op;
                    menu.classList.add('d-none');
                };
                menu.appendChild(item);
            });
            menu.classList.remove('d-none');
        });

        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !menu.contains(e.target)) {
                menu.classList.add('d-none');
            }
        });
    });
</script>
{% endblock %}
