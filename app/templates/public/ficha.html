{% extends "base.html" %} 
{% block title %}Ficha Técnica - {{ p.titulo }}{% endblock %} 

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="container mt-4 pb-5">
    
  <div class="row mb-4 align-items-center">
    <div class="col-6">
        <a href="/" class="text-decoration-none text-muted fw-medium border px-3 py-2 rounded-pill bg-white shadow-sm small text-nowrap">
            <i class="bi bi-arrow-left me-1"></i> Volver
        </a>
    </div>
    
    <div class="col-6 text-end">
        {% if current_user.is_authenticated %}
            <div class="d-inline-flex align-items-center bg-white px-3 py-2 rounded-pill shadow-sm border">
                <a href="{{ url_for('editar', id=p.id) }}" class="text-primary d-flex align-items-center" title="Editar Propiedad">
                    <i class="bi bi-pencil-square fs-5"></i>
                </a>
                
                <div class="vr mx-3 text-muted opacity-25"></div>
                
                <a href="{{ url_for('ver_legajo', id=p.id) }}" class="text-dark d-flex align-items-center" title="Ver Legajo Privado">
                    <i class="bi bi-folder-fill fs-5"></i>
                </a>

                <div class="vr mx-3 text-muted opacity-25"></div>

                <a href="#" class="text-danger d-flex align-items-center" title="Eliminar Propiedad"
                    data-bs-toggle="modal" data-bs-target="#modalEliminar" 
                    onclick="prepararEliminar('{{ url_for('eliminar', id=p.id) }}')">
                    <i class="bi bi-trash fs-5"></i>
                </a>
            </div>
        {% endif %}
    </div>
  </div>

  <div class="row mb-4">
      <div class="col-12">
          {% set fotos = p.archivos | selectattr('tipo', 'equalto', 'imagen') | list %} 
          {% set videos = p.archivos | selectattr('tipo', 'equalto', 'video') | list %} 
          {% set lista_ordenada = fotos + videos %}
          {% include 'includes/_carousel.html' %}
      </div>
  </div>

  <div class="row g-5">
    
    <div class="col-lg-4 order-1 order-lg-2">
      <div class="sticky-top" style="top: 2rem; z-index: 1;">
          
          <div class="mb-3">
              <span class="badge {{ 'bg-success' if p.operacion_rel.nombre == 'Venta' else 'bg-warning text-dark' }} rounded-pill px-3 shadow-sm">
                {{ p.operacion_rel.nombre|upper }}
              </span>
              <span class="badge bg-white text-dark border rounded-pill px-3 ms-1 shadow-sm">
                {{ p.tipo.nombre }}
              </span>
          </div>
          
          <h1 class="fw-bold h2 mb-2">{{ p.titulo }}</h1>
          <p class="text-muted mb-4">
            <i class="bi bi-geo-alt-fill text-danger me-1"></i> {{ p.barrio_rel.nombre }}, {{ p.localidad }}
          </p>

          <div class="mb-4 pb-4 border-bottom">
            <h2 class="text-primary fw-bold display-6">
              {{ p.moneda }} {{ "{:,.0f}".format(p.precio).replace(',', '.') if p.precio else 'Consultar' }}
            </h2>
          </div>

          <div class="row row-cols-2 g-4 mb-4">
            <div class="col d-flex align-items-center">
                <div class="bg-light p-2 rounded-circle me-3 text-secondary border"><i class="bi bi-arrows-fullscreen fs-5"></i></div>
                <div><span class="d-block small text-muted">Totales</span><span class="fw-bold">{{ p.m2_totales }} m²</span></div>
            </div>
            <div class="col d-flex align-items-center">
                <div class="bg-light p-2 rounded-circle me-3 text-secondary border"><i class="bi bi-house fs-5"></i></div>
                <div><span class="d-block small text-muted">Cubiertos</span><span class="fw-bold">{{ p.m2_cubiertos }} m²</span></div>
            </div>
            <div class="col d-flex align-items-center">
                <div class="bg-light p-2 rounded-circle me-3 text-secondary border"><i class="bi bi-door-open fs-5"></i></div>
                <div><span class="d-block small text-muted">Dormitorios</span><span class="fw-bold">{{ p.dormitorios }}</span></div>
            </div>
            <div class="col d-flex align-items-center">
                <div class="bg-light p-2 rounded-circle me-3 text-secondary border"><i class="bi bi-droplet fs-5"></i></div>
                <div><span class="d-block small text-muted">Baños</span><span class="fw-bold">{{ p.banios }}</span></div>
            </div>
          </div>

          {% if p.cochera or p.pileta or p.quincho or p.patio or p.terraza or p.balcon %}
          <div class="mb-4 pt-3 border-top">
            <h6 class="fw-bold mb-3 small text-muted text-uppercase">Comodidades</h6>
            <div class="d-flex flex-wrap gap-2">
                {% if p.cochera %}<span class="badge bg-white text-dark border px-3 py-2 rounded-pill"><i class="bi bi-car-front me-2 text-primary"></i>Cochera</span>{% endif %}
                {% if p.pileta %}<span class="badge bg-white text-dark border px-3 py-2 rounded-pill"><i class="bi bi-water me-2 text-info"></i>Pileta</span>{% endif %}
                {% if p.quincho %}<span class="badge bg-white text-dark border px-3 py-2 rounded-pill"><i class="bi bi-fire me-2 text-danger"></i>Quincho</span>{% endif %}
                {% if p.patio %}<span class="badge bg-white text-dark border px-3 py-2 rounded-pill"><i class="bi bi-tree me-2 text-success"></i>Patio</span>{% endif %}
                {% if p.terraza %}<span class="badge bg-white text-dark border px-3 py-2 rounded-pill"><i class="bi bi-border-outer me-2 text-secondary"></i>Terraza</span>{% endif %}
                {% if p.balcon %}<span class="badge bg-white text-dark border px-3 py-2 rounded-pill"><i class="bi bi-view-stacked me-2 text-primary"></i>Balcón</span>{% endif %}
            </div>
          </div>
          {% endif %}

          {% if not current_user.is_authenticated %}
          <div class="mt-4 d-none d-lg-block">
            <a href="https://wa.me/549351XXXXXXX?text={{ 'Hola, consulto por: ' + p.titulo + ' (Ref #' + p.id|string + ')' }}" 
               target="_blank"
               class="btn btn-success w-100 rounded-pill py-3 fw-bold shadow-sm">
                <i class="bi bi-whatsapp me-2"></i> Consultar Propiedad
            </a>
          </div>
          {% endif %}

          {% if current_user.is_authenticated %}
          <div class="d-none d-lg-block mt-4 p-3 bg-light rounded-4 border">
              <h6 class="small fw-bold mb-3"><i class="bi bi-share"></i> Marketing</h6>
              <div class="form-check form-switch mb-3">
                  <label class="form-check-label small" for="checkInmoDesktop">Mostrar logo Inmobiliaria</label>
                  <input class="form-check-input" type="checkbox" id="checkInmoDesktop" 
                         {% if p.mostrar_inmo %}checked{% endif %} 
                         onchange="actualizarVisualizacionInmo({{ p.id }}, this)">
              </div>
              <button onclick="compartirWhatsApp('{{ p.titulo }}', '{{ p.id }}')" class="btn btn-success w-100 rounded-pill fw-bold">
                  <i class="bi bi-whatsapp me-2"></i> Compartir Ficha
              </button>
          </div>
          {% endif %}

      </div>
    </div>

    <div class="col-lg-8 order-2 order-lg-1">
      <h5 class="fw-bold mb-3 border-bottom pb-2">Descripción</h5>
      <div class="text-secondary lh-lg mb-5" style="font-size: 1.05rem; white-space: pre-line;">
        {{ p.descripcion|safe }}
      </div>

      {% if p.latitud and p.longitud %}
      <div class="mb-5">
          <h5 class="fw-bold mb-3 border-bottom pb-2">Ubicación aproximada</h5>
          <div id="map-public" style="height: 400px; border-radius: 12px;" class="border shadow-sm"></div>
          <p class="small text-muted mt-2"><i class="bi bi-info-circle me-1"></i> El marcador indica la zona de la propiedad.</p>
      </div>
      {% endif %}

    </div>

  </div>
</div>

{% include 'includes/_modal_eliminar.html' %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/propiedades.js') }}"></script>
<script>
    // --- LÓGICA DEL MAPA PÚBLICO ---
    {% if p.latitud and p.longitud %}
        const mapPublic = L.map('map-public', {
            center: [{{ p.latitud }}, {{ p.longitud }}],
            zoom: 15,
            scrollWheelZoom: false // Para que no moleste al hacer scroll en la página
        });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapPublic);
        L.marker([{{ p.latitud }}, {{ p.longitud }}]).addTo(mapPublic);
    {% endif %}

    function actualizarVisualizacionInmo(id, elemento) {
        // ... (Tu lógica existente para actualizar logo inmobiliaria) ...
        fetch(`/toggle_inmo/${id}`, { method: 'POST' });
    }
</script>
{% endblock %}