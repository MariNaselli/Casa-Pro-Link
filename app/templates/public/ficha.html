{% extends "base.html" %} 
{% block title %}Ficha Técnica - {{ p.titulo }}{% endblock %} 

{% block content %}
<div class="container mt-4 pb-5">
    
  <div class="row mb-4 align-items-center">
    <div class="col-6">
        <a href="/" class="text-decoration-none text-muted fw-medium border px-3 py-2 rounded-pill bg-white shadow-sm small text-nowrap">
            <i class="bi bi-arrow-left me-1"></i> Volver a Propiedades
        </a>
    </div>
    <div class="col-6 text-end"></div>
  </div>

  <div class="row mb-4">
      <div class="col-12">
          {% set fotos = p.archivos | selectattr('tipo', 'equalto', 'imagen') | list %} 
          {% set videos = p.archivos | selectattr('tipo', 'equalto', 'video') | list %} 
          {% set lista_ordenada = fotos + videos %}
          {% include 'includes/_carousel.html' %}
      </div>
  </div>

  <div class="row g-5">
    
    <div class="col-lg-4 order-1 order-lg-2">
      <div class="sticky-top" style="top: 2rem; z-index: 1;">
          
          {% if current_user.is_authenticated %}
          <div class="mb-4">
              <div class="d-flex gap-2">
                  <a href="{{ url_for('editar', id=p.id) }}" class="btn btn-primary flex-fill fw-bold shadow-sm">
                      <i class="bi bi-pencil-square"></i> Editar
                  </a>
                  <a href="{{ url_for('ver_legajo', id=p.id) }}" class="btn btn-dark flex-fill fw-bold shadow-sm">
                      <i class="bi bi-folder-fill"></i> Legajo
                  </a>
                  <button type="button" class="btn btn-danger shadow-sm" data-bs-toggle="modal" data-bs-target="#modalEliminar" onclick="prepararEliminar('{{ url_for('eliminar', id=p.id) }}')">
                      <i class="bi bi-trash"></i>
                  </button>
              </div>
          </div>
          {% endif %}

          <div class="mb-3">
              <span class="badge {{ 'bg-success' if p.operacion_rel.nombre == 'Venta' else 'bg-warning text-dark' }} rounded-pill px-3 shadow-sm">
                {{ p.operacion_rel.nombre|upper }}
              </span>
              <span class="badge bg-white text-dark border rounded-pill px-3 ms-1 shadow-sm">
                {{ p.tipo.nombre }}
              </span>
          </div>
          
          <h1 class="fw-bold h2 mb-2">{{ p.titulo }}</h1>
          <p class="text-muted mb-4">
            <i class="bi bi-geo-alt-fill text-danger me-1"></i> {{ p.calle }} {{ p.altura }}, {{ p.barrio_rel.nombre }}
          </p>

          <div class="mb-4 pb-4 border-bottom">
            <h2 class="text-primary fw-bold display-6">
              {{ p.moneda }} {{ "{:,.0f}".format(p.precio).replace(',', '.') if p.precio else 'Consultar' }}
            </h2>
          </div>

          <div class="row row-cols-2 g-4 mb-4">
            <div class="col d-flex align-items-center">
                <div class="bg-light p-2 rounded-circle me-3 text-secondary border"><i class="bi bi-arrows-fullscreen fs-5"></i></div>
                <div><span class="d-block small text-muted">Totales</span><span class="fw-bold">{{ p.m2_totales }} m²</span></div>
            </div>
            <div class="col d-flex align-items-center">
                <div class="bg-light p-2 rounded-circle me-3 text-secondary border"><i class="bi bi-house fs-5"></i></div>
                <div><span class="d-block small text-muted">Cubiertos</span><span class="fw-bold">{{ p.m2_cubiertos }} m²</span></div>
            </div>
            <div class="col d-flex align-items-center">
                <div class="bg-light p-2 rounded-circle me-3 text-secondary border"><i class="bi bi-door-open fs-5"></i></div>
                <div><span class="d-block small text-muted">Habitaciones</span><span class="fw-bold">{{ p.dormitorios }}</span></div>
            </div>
            <div class="col d-flex align-items-center">
                <div class="bg-light p-2 rounded-circle me-3 text-secondary border"><i class="bi bi-droplet fs-5"></i></div>
                <div><span class="d-block small text-muted">Baños</span><span class="fw-bold">{{ p.banios }}</span></div>
            </div>
          </div>

          {% if p.cochera or p.pileta or p.quincho or p.patio %}
          <div class="mb-4 pt-3 border-top">
            <h6 class="fw-bold mb-3 small text-muted text-uppercase">Comodidades</h6>
            <div class="d-flex flex-wrap gap-2">
                {% if p.cochera %}<span class="badge bg-white text-dark border px-3 py-2 rounded-pill"><i class="bi bi-car-front me-2 text-primary"></i>Cochera</span>{% endif %}
                {% if p.pileta %}<span class="badge bg-white text-dark border px-3 py-2 rounded-pill"><i class="bi bi-water me-2 text-info"></i>Pileta</span>{% endif %}
                {% if p.quincho %}<span class="badge bg-white text-dark border px-3 py-2 rounded-pill"><i class="bi bi-fire me-2 text-danger"></i>Quincho</span>{% endif %}
                {% if p.patio %}<span class="badge bg-white text-dark border px-3 py-2 rounded-pill"><i class="bi bi-tree me-2 text-success"></i>Patio</span>{% endif %}
            </div>
          </div>
          {% endif %}

          {% if not current_user.is_authenticated %}
          <div class="mt-4 d-none d-lg-block">
            <a href="https://wa.me/549351XXXXXXX?text={{ 'Hola, consulto por: ' + p.titulo + ' (Ref #' + p.id|string + ')' }}" 
               target="_blank"
               class="btn btn-success w-100 rounded-pill py-3 fw-bold shadow-sm">
                <i class="bi bi-whatsapp me-2"></i> Consultar Propiedad
            </a>
          </div>
          {% endif %}

          {% if current_user.is_authenticated %}
          <div class="d-none d-lg-block mt-4 p-3 bg-light rounded-4 border">
              <h6 class="small fw-bold mb-3"><i class="bi bi-share"></i> Marketing</h6>
              <div class="form-check form-switch mb-3">
                  <label class="form-check-label small" for="checkInmoDesktop">Mostrar logo Inmobiliaria</label>
                  <input class="form-check-input" type="checkbox" id="checkInmoDesktop" 
                         {% if p.mostrar_inmo %}checked{% endif %} 
                         onchange="actualizarVisualizacionInmo({{ p.id }}, this)">
              </div>
              <button onclick="compartirWhatsApp('{{ p.titulo }}', '{{ p.id }}')" class="btn btn-success w-100 rounded-pill fw-bold">
                  <i class="bi bi-whatsapp me-2"></i> Compartir Ficha
              </button>
          </div>
          
          <div id="seccionInmoDesktop" class="d-none {{ 'd-lg-block' if p.mostrar_inmo }} card border-0 bg-light mt-4 shadow-sm">
            <div class="card-body d-flex align-items-center gap-3">
                <img src="{{ url_for('static', filename='img/logo.png') }}" onerror="this.style.display='none'; document.getElementById('iconFallbackPC').style.display='block';" style="height: 40px;">
                <i id="iconFallbackPC" class="bi bi-building fs-2 text-muted" style="display:none;"></i>
                <div class="lh-1"><span class="d-block fw-bold small">Inmobiliaria Hermano</span><span class="d-block text-muted" style="font-size: 10px;">Gestión Profesional</span></div>
            </div>
          </div>
          {% endif %}

      </div>
    </div>

    <div class="col-lg-8 order-2 order-lg-1">
      <h5 class="fw-bold mb-3 border-bottom pb-2">Descripción</h5>
      <div class="text-secondary lh-lg mb-5" style="font-size: 1.05rem; white-space: pre-line;">
        {{ p.descripcion|safe }}
      </div>

      {% if not current_user.is_authenticated %}
      <div class="d-block d-lg-none mt-4">
        <a href="https://wa.me/549351XXXXXXX?text={{ 'Hola, consulto por: ' + p.titulo + ' (Ref #' + p.id|string + ')' }}" 
           target="_blank"
           class="btn btn-success w-100 rounded-pill py-3 fw-bold shadow-lg">
            <i class="bi bi-whatsapp me-2"></i> Consultar por WhatsApp
        </a>
      </div>
      {% endif %}

      {% if current_user.is_authenticated %}
      <div class="d-block d-lg-none mt-5">
          <div class="card bg-dark text-white border-0 rounded-4 shadow-lg p-3">
              <h6 class="text-warning small fw-bold mb-3"><i class="bi bi-share-fill"></i> ZONA MARKETING</h6>
              
              <div class="form-check form-switch d-flex justify-content-between align-items-center mb-3 bg-white bg-opacity-10 p-2 rounded">
                  <label class="form-check-label small text-white" for="checkInmoMobile">¿Incluir firma Inmobiliaria?</label>
                  <input class="form-check-input" type="checkbox" id="checkInmoMobile" 
                         {% if p.mostrar_inmo %}checked{% endif %} 
                         onchange="actualizarVisualizacionInmo({{ p.id }}, this)">
              </div>

              <button onclick="compartirWhatsApp('{{ p.titulo }}', '{{ p.id }}')" class="btn btn-success w-100 rounded-pill fw-bold py-3">
                  <i class="bi bi-whatsapp me-2"></i> Compartir Ficha
              </button>
          </div>
      </div>

      <div id="seccionInmoMobile" class="d-block d-lg-none mt-4 {{ 'd-none' if not p.mostrar_inmo }}">
        <div class="text-center p-4 bg-light rounded-4 border border-dashed">
            <img src="{{ url_for('static', filename='img/logo.png') }}" 
                 onerror="this.style.display='none'; document.getElementById('iconFallbackMob').style.display='block';" 
                 style="height: 60px;" class="mb-2">
            <i id="iconFallbackMob" class="bi bi-building fs-1 text-primary mb-2" style="display:none;"></i>
            <h5 class="fw-bold text-primary mb-0">Inmobiliaria Hermano</h5>
            <p class="text-muted small mb-0">Gestión Inmobiliaria Profesional</p>
            <div class="mt-3">
                <span class="badge bg-success"><i class="bi bi-whatsapp"></i> 351-XXXXXXX</span>
            </div>
        </div>
      </div>
      {% endif %}

    </div>

  </div>
</div>

{% include 'includes/_modal_eliminar.html' %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/propiedades.js') }}"></script>
<script>
    // FUNCIÓN CORREGIDA: Recibe 'elemento' para saber cuál se tocó
    function actualizarVisualizacionInmo(id, elemento) {
        const estado = elemento.checked;
        const idMob = 'checkInmoMobile';
        const idPC = 'checkInmoDesktop';
        
        // 1. Sincronizar el otro switch (si existe en pantalla)
        if (elemento.id === idMob) {
            const otro = document.getElementById(idPC);
            if(otro) otro.checked = estado;
        } else if (elemento.id === idPC) {
            const otro = document.getElementById(idMob);
            if(otro) otro.checked = estado;
        }

        // 2. Controlar visibilidad de las secciones
        const sectionMob = document.getElementById('seccionInmoMobile');
        const sectionPC = document.getElementById('seccionInmoDesktop');
        
        if (estado) {
            // MOSTRAR:
            // Móvil: Quitamos d-none (queda d-block por defecto)
            if(sectionMob) sectionMob.classList.remove('d-none');
            // PC: Agregamos d-lg-block para que se vea en desktop
            if(sectionPC) sectionPC.classList.add('d-lg-block');
        } else {
            // OCULTAR:
            // Móvil: Ponemos d-none
            if(sectionMob) sectionMob.classList.add('d-none');
            // PC: Quitamos d-lg-block (al tener d-none base, se oculta)
            if(sectionPC) sectionPC.classList.remove('d-lg-block');
        }

        // 3. Guardar en Base de Datos
        fetch(`/toggle_inmo/${id}`, { method: 'POST' });
    }
</script>
{% endblock %}