{% extends "base.html" %} 

{% block title %}Cat치logo - Gesti칩n Interna{% endblock %} 

{% block content %}
<div class="container">
  <div class="row justify-content-center my-5">
    <div class="col-md-6">
      <form action="/" method="GET" class="input-group input-group-md shadow-sm">
        <input type="text" name="q" class="form-control border-0" placeholder="Buscar por t칤tulo o ubicaci칩n..." value="{{ busqueda if busqueda else '' }}" />
        <button class="btn btn-primary" type="submit">
          <i class="bi bi-search"></i>
        </button>
        {% if busqueda %}
        <a href="/" class="btn btn-outline-secondary border-0">Limpiar</a>
        {% endif %}
      </form>
    </div>
  </div>

  <div class="container pb-5">
    <div class="row row-cols-1 row-cols-md-4 g-4">
      {% for p in propiedades %}
      <div class="col">
        <div class="card h-100 shadow-sm border-0 position-relative">
          
          {# --- L칍GICA DE IMAGEN CORREGIDA PARA TU MODELO --- #}
          {# Buscamos en p.archivos porque as칤 definiste la relaci칩n en models.py #}
          {% set imagen_principal = p.archivos | selectattr('tipo', 'equalto', 'imagen') | first %}
          
          {% if imagen_principal %}
            <img src="{{ url_for('static', filename='uploads/' + imagen_principal.archivo_nombre) }}" 
                 class="card-img-top" 
                 alt="{{ p.titulo }}"
                 style="height: 180px; object-fit: cover;">
          {% else %}
            <div class="bg-light d-flex align-items-center justify-content-center border-bottom text-muted" style="height: 180px;">
              <div class="text-center">
                <i class="bi bi-image fs-1"></i><br>
                <small>Sin fotos</small>
              </div>
            </div>
          {% endif %}

          {# Badge de Operaci칩n (Venta/Alquiler) #}
          <div class="position-absolute top-0 end-0 m-2">
            <span class="badge {{ 'bg-success' if p.operacion == 'Venta' else 'bg-warning text-dark' }} shadow-sm">
              {{ p.operacion }}
            </span>
          </div>
          {# --- FIN L칍GICA DE IMAGEN --- #}

          <div class="card-body p-3">
            <h6 class="fw-bold mb-1 text-truncate">{{ p.titulo }}</h6>
            <p class="text-muted small mb-2">
              <i class="bi bi-geo-alt"></i> {{ p.barrio }}
            </p>
            <h6 class="text-primary fw-bold mb-0">
              {{ p.moneda }} {{ "{:,.0f}".format(p.precio).replace(',', '.') if p.precio else '0' }}
            </h6>
          </div>

          <div class="card-footer bg-white border-0 p-3 pt-0">
            <div class="d-flex align-items-center justify-content-between">
              <a href="{{ url_for('ficha', id=p.id) }}" class="btn btn-sm btn-link p-0 text-decoration-none fw-bold">Ver detalle</a>

              <div class="d-flex gap-3">
                {% if session.admin_logged_in %}
                <a href="{{ url_for('editar', id=p.id, next='home') }}" class="link-primary" title="Editar">
                  <i class="bi bi-pencil"></i>
                </a>

                <a href="#" class="link-danger" title="Eliminar" data-bs-toggle="modal" data-bs-target="#modalEliminar" onclick="prepararEliminar('{{ url_for('eliminar', id=p.id) }}')">
                  <i class="bi bi-trash"></i>
                </a>

                <a href="#" class="link-success" title="Compartir v칤a WhatsApp" onclick="compartirWhatsApp('{{ p.titulo }}', '{{ p.id }}')">
                  <i class="bi bi-whatsapp"></i>
                </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  {% if not propiedades %}
  <div class="text-center mt-5">
    <h4 class="text-muted">No se encontraron propiedades...</h4>
    <a href="/" class="btn btn-link">Ver todo el cat치logo</a>
  </div>
  {% endif %}
</div>

{# Modales y Scripts... #}
<div class="modal fade" id="modalEliminar" tabindex="-1" aria-labelledby="modalEliminarLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold" id="modalEliminarLabel">Confirmar eliminaci칩n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center p-4">
        <p class="mb-0 text-muted">쮼st치s seguro que deseas eliminar esta propiedad?</p>
      </div>
      <div class="modal-footer border-0 justify-content-between">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <a id="btnConfirmarEliminar" href="#" class="btn btn-danger px-4">S칤, eliminar</a>
      </div>
    </div>
  </div>
</div>

<script>
  function prepararEliminar(url) {
    document.getElementById("btnConfirmarEliminar").setAttribute("href", url);
  }

  function compartirWhatsApp(titulo, id) {
    const urlFicha = window.location.origin + "/propiedad/" + id;
    const texto = "춰Hola! Te comparto la ficha de esta propiedad:\n\n" + "游 *" + titulo + "*\n" + "游댕 Ver detalles aqu칤: " + urlFicha;
    const urlFinal = "https://wa.me/?text=" + encodeURIComponent(texto);
    window.open(urlFinal, "_blank");
  }
</script>
{% endblock %}